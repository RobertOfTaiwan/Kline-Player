# 均線歷史資料同步功能說明

## 功能概述

此功能確保均線計算的準確性，透過自動載入額外的歷史資料來計算均線值。

## 運作原理

### 1. 自動計算歷史資料需求

當用戶選擇時間範圍和均線配置時，系統會：

- 檢查所有啟用的均線配置
- 找出最長的均線週期（例如 EMA60）
- 自動在用戶選擇的開始時間之前載入足夠的歷史資料

### 2. 範例說明

**用戶設定：**
- 時間範圍：2025/01/01 00:00:00 - 2025/01/07 23:59:59
- K線間隔：1小時
- 均線配置：EMA12、EMA26、EMA60

**系統運作：**
1. 檢測最長週期：EMA60 需要 60 個小時的歷史資料
2. 計算實際載入範圍：
   - 用戶開始時間：2025/01/01 00:00:00
   - 實際載入開始時間：2024/12/29 12:00:00（提前 60+緩衝 小時）
   - 載入結束時間：2025/01/07 23:59:59（用戶設定）

### 3. 資料處理流程

```
1. 計算歷史資料需求
   ├── 檢查啟用的均線配置
   ├── 找出最大週期 (max_period)
   └── 設定緩衝週期 (至少100個週期)

2. 調整 API 請求範圍
   ├── actual_start = user_start - (buffer_periods × interval_ms)
   └── actual_end = user_end

3. 載入和處理資料
   ├── 從 API 載入完整範圍的資料
   ├── 設定 historicalData (完整資料，用於均線計算)
   └── 設定 displayData (用戶範圍內的資料，用於顯示)

4. 均線計算
   ├── 使用完整的 historicalData 計算均線
   └── 均線從第一個有效值開始顯示
```

### 4. 均線計算精確性

**傳統問題：**
- 如果只載入用戶選擇範圍的資料
- EMA60 的第一個值會不準確（因為沒有足夠的歷史資料）

**解決方案：**
- 載入額外的 60+ 個週期的歷史資料
- EMA60 從第 60 個資料點開始就能提供準確的值
- 用戶看到的第一個 K線 的 EMA60 值是基於充分歷史資料計算的

### 5. 不同時間間隔的處理

| 時間間隔 | 均線週期範例 | 額外載入時間 |
|----------|------------|------------|
| 5分鐘    | EMA60      | 5小時      |
| 1小時    | EMA60      | 60小時     |
| 4小時    | EMA24      | 96小時     |
| 1天      | EMA20      | 20天       |

### 6. 使用者體驗

**靜態模式：**
- 顯示用戶選擇範圍內的完整 K線 和準確的均線

**播放器模式：**
- 從用戶選擇的開始時間開始播放
- 每個 K線 的均線值都基於充分的歷史資料
- 進度條反映用戶選擇範圍內的播放進度

### 7. 技術實作細節

**前端修改：**
- `handleLoadData`: 計算實際載入範圍
- `getIntervalMilliseconds`: 時間間隔轉換
- 播放控制函數：正確處理用戶範圍 vs 完整資料

**後端支援：**
- API 已支援 `startTime` 和 `endTime` 參數
- 自動從 Binance 獲取指定範圍的資料

### 8. 效能考量

- **快取機制：** 後端會將資料存入資料庫，避免重複 API 調用
- **緩衝限制：** 最多載入 100 個額外週期，避免載入過多資料
- **漸進載入：** 大範圍資料會分批從 Binance API 載入

## 總結

此功能確保了均線計算的準確性，讓用戶在任何時間範圍內都能看到基於充分歷史資料計算的均線值，提供更可靠的技術分析工具。
